<!DOCTYPE html>
<html>
<head>
<title>storage.go</title>
<meta charset="utf-8"/>
<style type="text/css">body {
    background: rgb(225, 225, 225);
    margin: 0px;
    padding: 0px;
}

#docgo p {
    margin-top: 0px;
    margin-right: 0px;
    margin-bottom: 15px;
    margin-left: 0px;
}

#docgo div {
    display: inline;
}

#docgo #background {
    position: fixed;
    top: 0; left: 525px; right: 0; bottom: 0;
    background: rgb(47, 47, 47);
    border-left: 1px solid #e5e5ee;
    z-index: -1;
}

#docgo .keyword {
    color: rgb(250, 200, 100);
}

#docgo .literal {
    color: rgb(140, 190, 100);
}

#docgo .ident {
    color: white;
}

#docgo .operator {
    color: white;
}

#docgo .comment {
}

#docgo h1, h2, h3, h4, h5 {
    text-align: left;
    margin-top: 0px;
    margin-right: 0px;
    margin-bottom: 15px;
    margin-left: 0px;
}

#docgo h1 {
    margin-top: 40px;
}

#docgo .doc {
    vertical-align: top;
    font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, FreeSerif, serif;
    font-size: 15px;
    line-height: 22px;
    color: black;
    min-width: 450px;
    max-width: 450px;
    padding-top: 10px;
    padding-right: 25px;
    padding-bottom: 1px;
    padding-left: 50px;
    overflow-x: hidden;
}

#docgo .code {
    min-width: 650px;
    max-width: 650px;
    padding-left: 25px;
    padding-right: 15px;
    border-left: 1px;
    overflow-x: hidden;
    vertical-align: top;
}

#docgo .code pre code  {
    font-size: 12px;
    line-height: 18px;
    font-family: Menlo, Monaco, Consolas, "Lucida Console", monospace;
    color: rgb(120, 120, 120);
}
</style>
</head>
<body>
<div id="docgo">
  <div id="background"></div>
  <table>
    <thead><tr><th class="doc"><h1>storage.go</h1></th><th class="code"></th></tr></thead>
    <tbody>
      
      <tr class="section">
	<td class="doc"></td>
	<td class="code"><pre><code><div class="comment">/*
Copyright Â© 2019, 2020 Red Hat, Inc.

Licensed under the Apache License, Version 2.0 (the &#34;License&#34;);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an &#34;AS IS&#34; BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/</div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Package storage contains an implementation of interface between Go code and
(almost any) SQL database like PostgreSQL, SQLite, or MariaDB. An implementation
named DBStorage is constructed via New function and it is mandatory to call Close
for any opened connection to database.</p>
</td>
	<td class="code"><pre><code><div class="keyword">package</div> <div class="ident">storage</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Generated documentation is available at:
https://godoc.org/github.com/RedHatInsights/insights-operator-controller/storage</p>

<p>Documentation in literate-programming-style is available at:
https://redhatinsights.github.io/insights-operator-controller/packages/storage/storage.html</p>
</td>
	<td class="code"><pre><code>
<div class="keyword">import</div> <div class="operator">(</div>
	<div class="literal">&#34;context&#34;</div><div class="operator"></div>
	<div class="literal">&#34;database/sql&#34;</div><div class="operator"></div>
	<div class="literal">&#34;errors&#34;</div><div class="operator"></div>
	<div class="literal">&#34;fmt&#34;</div><div class="operator"></div>
	<div class="literal">&#34;log&#34;</div><div class="operator"></div>
	<div class="literal">&#34;strconv&#34;</div><div class="operator"></div>
	<div class="literal">&#34;time&#34;</div><div class="operator"></div>

	<div class="ident">sq</div> <div class="literal">&#34;github.com/Masterminds/squirrel&#34;</div><div class="operator"></div>
	<div class="ident">_</div> <div class="literal">&#34;github.com/lib/pq&#34;</div>           <div class="operator"></div><div class="comment">// PostgreSQL database driver</div>
	<div class="ident">_</div> <div class="literal">&#34;github.com/mattn/go-sqlite3&#34;</div> <div class="operator"></div><div class="comment">// SQLite database driver</div>
<div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Storage represents an interface to any relational database based on SQL language</p>
</td>
	<td class="code"><pre><code><div class="keyword">type</div> <div class="ident">Storage</div> <div class="keyword">struct</div> <div class="operator">{</div>
	<div class="ident">connections</div> <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">DB</div><div class="operator"></div>
	<div class="ident">driver</div>      <div class="ident">string</div><div class="operator"></div>
	<div class="ident">placeholder</div> <div class="ident">sq</div><div class="operator">.</div><div class="ident">PlaceholderFormat</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Column is typed reference to a sql column, which is further used by particular storage objects</p>
</td>
	<td class="code"><pre><code><div class="keyword">type</div> <div class="ident">Column</div> <div class="ident">string</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">enableForeignKeys</div><div class="operator">(</div><div class="ident">connections</div> <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">DB</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">log</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="literal">&#34;Enabling foreign_keys pragma for sqlite&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">statement</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">connections</div><div class="operator">.</div><div class="ident">Prepare</div><div class="operator">(</div><div class="literal">&#34;PRAGMA foreign_keys = ON&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Fatal</div><div class="operator">(</div><div class="literal">&#34;Can prepare statement set PRAGMA for sqlite&#34;</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>statement has to be closed at function exit</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">defer</div> <div class="keyword">func</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>try to close the statement</p>
</td>
	<td class="code"><pre><code>		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">statement</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>in case of error all we can do is to just log the error</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">statement</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Fatal</div><div class="operator">(</div><div class="literal">&#34;Can not set PRAGMA for sqlite&#34;</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>New function creates and initializes a new instance of Storage structure</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">New</div><div class="operator">(</div><div class="ident">driverName</div> <div class="ident">string</div><div class="operator">,</div> <div class="ident">dataSourceName</div> <div class="ident">string</div><div class="operator">)</div> <div class="operator">(</div><div class="ident">Storage</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">log</div><div class="operator">.</div><div class="ident">Printf</div><div class="operator">(</div><div class="literal">&#34;Making connection to data storage, driver=%s datasource=%s&#34;</div><div class="operator">,</div> <div class="ident">driverName</div><div class="operator">,</div> <div class="ident">dataSourceName</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">connections</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">sql</div><div class="operator">.</div><div class="ident">Open</div><div class="operator">(</div><div class="ident">driverName</div><div class="operator">,</div> <div class="ident">dataSourceName</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="literal">&#34;Can not connect to data storage&#34;</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">Storage</div><div class="operator">{</div><div class="operator">}</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="ident">s</div> <div class="operator">:=</div> <div class="ident">Storage</div><div class="operator">{</div><div class="ident">connections</div><div class="operator">:</div> <div class="ident">connections</div><div class="operator">,</div> <div class="ident">driver</div><div class="operator">:</div> <div class="ident">driverName</div><div class="operator">}</div><div class="operator"></div>

	<div class="keyword">switch</div> <div class="ident">driverName</div> <div class="operator">{</div>
	<div class="keyword">case</div> <div class="literal">&#34;sqlite3&#34;</div><div class="operator">:</div>
		<div class="ident">enableForeignKeys</div><div class="operator">(</div><div class="ident">connections</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">s</div><div class="operator">.</div><div class="ident">placeholder</div> <div class="operator">=</div> <div class="ident">sq</div><div class="operator">.</div><div class="ident">Question</div><div class="operator"></div>
	<div class="keyword">case</div> <div class="literal">&#34;postgres&#34;</div><div class="operator">:</div>
		<div class="ident">s</div><div class="operator">.</div><div class="ident">placeholder</div> <div class="operator">=</div> <div class="ident">sq</div><div class="operator">.</div><div class="ident">Dollar</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">s</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>NewFromConnection function creates and initializes a new instance of Storage interface from prepared connection</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">NewFromConnection</div><div class="operator">(</div><div class="ident">connection</div> <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">DB</div><div class="operator">,</div> <div class="ident">driverName</div> <div class="ident">string</div><div class="operator">)</div> <div class="ident">Storage</div> <div class="operator">{</div>
	<div class="keyword">return</div> <div class="ident">Storage</div><div class="operator">{</div>
		<div class="ident">connections</div><div class="operator">:</div> <div class="ident">connection</div><div class="operator">,</div>
		<div class="ident">driver</div><div class="operator">:</div>      <div class="ident">driverName</div><div class="operator">,</div>
	<div class="operator">}</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Placeholder returns current query argument placeholder
(?, or $).It depends on driver used. In squirrel format</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">Storage</div><div class="operator">)</div> <div class="ident">Placeholder</div><div class="operator">(</div><div class="operator">)</div> <div class="ident">sq</div><div class="operator">.</div><div class="ident">PlaceholderFormat</div> <div class="operator">{</div>
	<div class="keyword">return</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">placeholder</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Connections is sql.DB connection</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">Storage</div><div class="operator">)</div> <div class="ident">Connections</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">DB</div> <div class="operator">{</div>
	<div class="keyword">return</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connections</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Close method closes the connection to database. Needs to be called at the end of application lifecycle.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">Storage</div><div class="operator">)</div> <div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">log</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="literal">&#34;Closing connection to data storage&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connections</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connections</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Fatal</div><div class="operator">(</div><div class="literal">&#34;Can not close connection to data storage&#34;</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>ID represents unique ID for any object.</p>
</td>
	<td class="code"><pre><code><div class="keyword">type</div> <div class="ident">ID</div> <div class="ident">int</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Name represents common name of object stored in database.</p>
</td>
	<td class="code"><pre><code><div class="keyword">type</div> <div class="ident">Name</div> <div class="ident">string</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>ClusterID represents unique key of cluster stored in database.</p>
</td>
	<td class="code"><pre><code><div class="keyword">type</div> <div class="ident">ClusterID</div> <div class="ident">ID</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>ClusterName represents name of cluster in format c8590f31-e97e-4b85-b506-c45ce1911a12</p>
</td>
	<td class="code"><pre><code><div class="keyword">type</div> <div class="ident">ClusterName</div> <div class="ident">Name</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Cluster represents cluster record in the controller service.
    ID: unique key
    Name: cluster GUID in the following format:
        c8590f31-e97e-4b85-b506-c45ce1911a12</p>
</td>
	<td class="code"><pre><code><div class="keyword">type</div> <div class="ident">Cluster</div> <div class="keyword">struct</div> <div class="operator">{</div>
	<div class="ident">ID</div>   <div class="ident">ClusterID</div>   <div class="literal">`json:&#34;id&#34;`</div><div class="operator"></div>
	<div class="ident">Name</div> <div class="ident">ClusterName</div> <div class="literal">`json:&#34;name&#34;`</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>ConfigurationID represents unique key of configuration stored in database.</p>
</td>
	<td class="code"><pre><code><div class="keyword">type</div> <div class="ident">ConfigurationID</div> <div class="ident">ID</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>ConfigurationProfile represents configuration profile record in the controller service.
    ID: unique key
    Configuration: a JSON structure stored in a string
    ChangeAt: username of admin that created or updated the configuration
    ChangeBy: timestamp of the last configuration change
    Description: a string with any comment(s) about the configuration</p>
</td>
	<td class="code"><pre><code><div class="keyword">type</div> <div class="ident">ConfigurationProfile</div> <div class="keyword">struct</div> <div class="operator">{</div>
	<div class="ident">ID</div>            <div class="ident">ConfigurationID</div> <div class="literal">`json:&#34;id&#34;`</div><div class="operator"></div>
	<div class="ident">Configuration</div> <div class="ident">string</div>          <div class="literal">`json:&#34;configuration&#34;`</div><div class="operator"></div>
	<div class="ident">ChangedAt</div>     <div class="ident">string</div>          <div class="literal">`json:&#34;changed_at&#34;`</div><div class="operator"></div>
	<div class="ident">ChangedBy</div>     <div class="ident">string</div>          <div class="literal">`json:&#34;changed_by&#34;`</div><div class="operator"></div>
	<div class="ident">Description</div>   <div class="ident">string</div>          <div class="literal">`json:&#34;description&#34;`</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>ClusterConfigurationID represents unique key of cluster configuration stored in database.</p>
</td>
	<td class="code"><pre><code><div class="keyword">type</div> <div class="ident">ClusterConfigurationID</div> <div class="ident">ID</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>ClusterConfiguration represents cluster configuration record in the controller service.
    ID: unique key
    Cluster: cluster ID (not name)
    Configuration: a JSON structure stored in a string
    ChangeAt: timestamp of the last configuration change
    ChangeBy: username of admin that created or updated the configuration
    Active: flag indicating whether the configuration is active or not
    Reason: a string with any comment(s) about the cluster configuration</p>
</td>
	<td class="code"><pre><code><div class="keyword">type</div> <div class="ident">ClusterConfiguration</div> <div class="keyword">struct</div> <div class="operator">{</div>
	<div class="ident">ID</div>            <div class="ident">ClusterConfigurationID</div> <div class="literal">`json:&#34;id&#34;`</div><div class="operator"></div>
	<div class="ident">Cluster</div>       <div class="ident">string</div>                 <div class="literal">`json:&#34;cluster&#34;`</div><div class="operator"></div>
	<div class="ident">Configuration</div> <div class="ident">string</div>                 <div class="literal">`json:&#34;configuration&#34;`</div><div class="operator"></div>
	<div class="ident">ChangedAt</div>     <div class="ident">string</div>                 <div class="literal">`json:&#34;changed_at&#34;`</div><div class="operator"></div>
	<div class="ident">ChangedBy</div>     <div class="ident">string</div>                 <div class="literal">`json:&#34;changed_by&#34;`</div><div class="operator"></div>
	<div class="ident">Active</div>        <div class="ident">string</div>                 <div class="literal">`json:&#34;active&#34;`</div><div class="operator"></div>
	<div class="ident">Reason</div>        <div class="ident">string</div>                 <div class="literal">`json:&#34;reason&#34;`</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TriggerID represents unique key of trigger stored in database.</p>
</td>
	<td class="code"><pre><code><div class="keyword">type</div> <div class="ident">TriggerID</div> <div class="ident">ID</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Trigger represents trigger record in the controller service
    ID: unique key
    Type: ID of trigger type
    Cluster: cluster ID (not name)
    Reason: a string with any comment(s) about the trigger
    Link: link to any document with customer ACK with the trigger
    TriggeredAt: timestamp of the last configuration change
    TriggeredBy: username of admin that created or updated the trigger
    AckedAt: timestamp where the insights operator acked the trigger
    Parameters: parameters that needs to be pass to trigger code
    Active: flag indicating whether the trigger is still active or not</p>
</td>
	<td class="code"><pre><code><div class="keyword">type</div> <div class="ident">Trigger</div> <div class="keyword">struct</div> <div class="operator">{</div>
	<div class="ident">ID</div>          <div class="ident">TriggerID</div> <div class="literal">`json:&#34;id&#34;`</div><div class="operator"></div>
	<div class="ident">Type</div>        <div class="ident">string</div>    <div class="literal">`json:&#34;type&#34;`</div><div class="operator"></div>
	<div class="ident">Cluster</div>     <div class="ident">string</div>    <div class="literal">`json:&#34;cluster&#34;`</div><div class="operator"></div>
	<div class="ident">Reason</div>      <div class="ident">string</div>    <div class="literal">`json:&#34;reason&#34;`</div><div class="operator"></div>
	<div class="ident">Link</div>        <div class="ident">string</div>    <div class="literal">`json:&#34;link&#34;`</div><div class="operator"></div>
	<div class="ident">TriggeredAt</div> <div class="ident">string</div>    <div class="literal">`json:&#34;triggered_at&#34;`</div><div class="operator"></div>
	<div class="ident">TriggeredBy</div> <div class="ident">string</div>    <div class="literal">`json:&#34;triggered_by&#34;`</div><div class="operator"></div>
	<div class="ident">AckedAt</div>     <div class="ident">string</div>    <div class="literal">`json:&#34;acked_at&#34;`</div><div class="operator"></div>
	<div class="ident">Parameters</div>  <div class="ident">string</div>    <div class="literal">`json:&#34;parameters&#34;`</div><div class="operator"></div>
	<div class="ident">Active</div>      <div class="ident">int</div>       <div class="literal">`json:&#34;active&#34;`</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>ListOfClusters method selects all clusters from database.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">Storage</div><div class="operator">)</div> <div class="ident">ListOfClusters</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">Cluster</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">clusters</div> <div class="operator">:=</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">Cluster</div><div class="operator">{</div><div class="operator">}</div><div class="operator"></div>

	<div class="ident">rows</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connections</div><div class="operator">.</div><div class="ident">Query</div><div class="operator">(</div><div class="literal">&#34;SELECT id, name FROM cluster&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">clusters</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>close the query at function exit</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">defer</div> <div class="keyword">func</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">for</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Next</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="keyword">var</div> <div class="ident">id</div> <div class="ident">int</div><div class="operator"></div>
		<div class="keyword">var</div> <div class="ident">name</div> <div class="ident">string</div><div class="operator"></div>

		<div class="ident">err</div> <div class="operator">=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">id</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">name</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">==</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">clusters</div> <div class="operator">=</div> <div class="ident">append</div><div class="operator">(</div><div class="ident">clusters</div><div class="operator">,</div> <div class="ident">Cluster</div><div class="operator">{</div><div class="ident">ClusterID</div><div class="operator">(</div><div class="ident">id</div><div class="operator">)</div><div class="operator">,</div> <div class="ident">ClusterName</div><div class="operator">(</div><div class="ident">name</div><div class="operator">)</div><div class="operator">}</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div> <div class="keyword">else</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="literal">&#34;error&#34;</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">clusters</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>GetCluster method selects the specified cluster from database. Also see GetClusterByName.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">Storage</div><div class="operator">)</div> <div class="ident">GetCluster</div><div class="operator">(</div><div class="ident">id</div> <div class="ident">int</div><div class="operator">)</div> <div class="operator">(</div><div class="ident">Cluster</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">var</div> <div class="ident">cluster</div> <div class="ident">Cluster</div><div class="operator"></div>

	<div class="ident">rows</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connections</div><div class="operator">.</div><div class="ident">Query</div><div class="operator">(</div><div class="literal">&#34;SELECT id, name FROM cluster WHERE id = $1&#34;</div><div class="operator">,</div> <div class="ident">id</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">cluster</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>close the query at function exit</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">defer</div> <div class="keyword">func</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Next</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="keyword">var</div> <div class="ident">id</div> <div class="ident">int</div><div class="operator"></div>
		<div class="keyword">var</div> <div class="ident">name</div> <div class="ident">string</div><div class="operator"></div>

		<div class="ident">err</div> <div class="operator">=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">id</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">name</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">==</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">cluster</div><div class="operator">.</div><div class="ident">ID</div> <div class="operator">=</div> <div class="ident">ClusterID</div><div class="operator">(</div><div class="ident">id</div><div class="operator">)</div><div class="operator"></div>
			<div class="ident">cluster</div><div class="operator">.</div><div class="ident">Name</div> <div class="operator">=</div> <div class="ident">ClusterName</div><div class="operator">(</div><div class="ident">name</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div> <div class="keyword">else</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="literal">&#34;error&#34;</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div> <div class="keyword">else</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">cluster</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">ItemNotFoundError</div><div class="operator">{</div>
			<div class="ident">ItemID</div><div class="operator">:</div> <div class="ident">id</div><div class="operator">,</div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">cluster</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>RegisterNewCluster inserts information about new cluster into the database.
It differs from CreateNewCluster, because ID is not specified explicitly here.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">Storage</div><div class="operator">)</div> <div class="ident">RegisterNewCluster</div><div class="operator">(</div><div class="ident">name</div> <div class="ident">string</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
	<div class="ident">statement</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connections</div><div class="operator">.</div><div class="ident">Prepare</div><div class="operator">(</div><div class="literal">&#34;INSERT INTO cluster(name) VALUES ($1)&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>statement has to be closed at function exit</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">defer</div> <div class="keyword">func</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>try to close the statement</p>
</td>
	<td class="code"><pre><code>		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">statement</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>in case of error all we can do is to just log the error</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">statement</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="ident">name</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>CreateNewCluster creates a new cluster with specified ID and name.
It differs from RegisterNewCluster, because ID is specified explicitly here.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">Storage</div><div class="operator">)</div> <div class="ident">CreateNewCluster</div><div class="operator">(</div><div class="ident">id</div> <div class="ident">int64</div><div class="operator">,</div> <div class="ident">name</div> <div class="ident">string</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
	<div class="ident">statement</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connections</div><div class="operator">.</div><div class="ident">Prepare</div><div class="operator">(</div><div class="literal">&#34;INSERT INTO cluster(id, name) VALUES ($1, $2)&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Print</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>statement has to be closed at function exit</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">defer</div> <div class="keyword">func</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>try to close the statement</p>
</td>
	<td class="code"><pre><code>		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">statement</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>in case of error all we can do is to just log the error</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">statement</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="ident">id</div><div class="operator">,</div> <div class="ident">name</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>DeleteCluster deletes cluster with specified ID from the database.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">Storage</div><div class="operator">)</div> <div class="ident">DeleteCluster</div><div class="operator">(</div><div class="ident">id</div> <div class="ident">int64</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
	<div class="ident">statement</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connections</div><div class="operator">.</div><div class="ident">Prepare</div><div class="operator">(</div><div class="literal">&#34;DELETE FROM cluster WHERE id = $1&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Print</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>statement has to be closed at function exit</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">defer</div> <div class="keyword">func</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>try to close the statement</p>
</td>
	<td class="code"><pre><code>		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">statement</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>in case of error all we can do is to just log the error</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">rowsAffected</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">execStatementAndGetRowsAffected</div><div class="operator">(</div><div class="ident">statement</div><div class="operator">,</div> <div class="ident">id</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">rowsAffected</div> <div class="operator">==</div> <div class="literal">0</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="operator">&amp;</div><div class="ident">ItemNotFoundError</div><div class="operator">{</div>
			<div class="ident">ItemID</div><div class="operator">:</div> <div class="ident">id</div><div class="operator">,</div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>DeleteClusterByName deletes cluster with specified name from the database.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">Storage</div><div class="operator">)</div> <div class="ident">DeleteClusterByName</div><div class="operator">(</div><div class="ident">name</div> <div class="ident">string</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
	<div class="ident">statement</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connections</div><div class="operator">.</div><div class="ident">Prepare</div><div class="operator">(</div><div class="literal">&#34;DELETE FROM cluster WHERE name = $1&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Print</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>statement has to be closed at function exit</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">defer</div> <div class="keyword">func</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>try to close the statement</p>
</td>
	<td class="code"><pre><code>		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">statement</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>in case of error all we can do is to just log the error</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">rowsAffected</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">execStatementAndGetRowsAffected</div><div class="operator">(</div><div class="ident">statement</div><div class="operator">,</div> <div class="ident">name</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">rowsAffected</div> <div class="operator">==</div> <div class="literal">0</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="operator">&amp;</div><div class="ident">ItemNotFoundError</div><div class="operator">{</div>
			<div class="ident">ItemID</div><div class="operator">:</div> <div class="ident">name</div><div class="operator">,</div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>GetClusterByName selects a cluster specified by its name. Also see GetCluster.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">Storage</div><div class="operator">)</div> <div class="ident">GetClusterByName</div><div class="operator">(</div><div class="ident">name</div> <div class="ident">string</div><div class="operator">)</div> <div class="operator">(</div><div class="ident">Cluster</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">var</div> <div class="ident">cluster</div> <div class="ident">Cluster</div><div class="operator"></div>

	<div class="ident">rows</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connections</div><div class="operator">.</div><div class="ident">Query</div><div class="operator">(</div><div class="literal">&#34;SELECT id, name FROM cluster WHERE name = $1&#34;</div><div class="operator">,</div> <div class="ident">name</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Print</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">cluster</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>close the query at function exit</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">defer</div> <div class="keyword">func</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Next</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="keyword">var</div> <div class="ident">id</div> <div class="ident">int</div><div class="operator"></div>
		<div class="keyword">var</div> <div class="ident">name</div> <div class="ident">string</div><div class="operator"></div>

		<div class="ident">err</div> <div class="operator">=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">id</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">name</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">==</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">cluster</div><div class="operator">.</div><div class="ident">ID</div> <div class="operator">=</div> <div class="ident">ClusterID</div><div class="operator">(</div><div class="ident">id</div><div class="operator">)</div><div class="operator"></div>
			<div class="ident">cluster</div><div class="operator">.</div><div class="ident">Name</div> <div class="operator">=</div> <div class="ident">ClusterName</div><div class="operator">(</div><div class="ident">name</div><div class="operator">)</div><div class="operator"></div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Printf</div><div class="operator">(</div><div class="literal">&#34;Cluster name %s has id %d\n&#34;</div><div class="operator">,</div> <div class="ident">name</div><div class="operator">,</div> <div class="ident">id</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div> <div class="keyword">else</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="literal">&#34;error&#34;</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div> <div class="keyword">else</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">cluster</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">ItemNotFoundError</div><div class="operator">{</div>
			<div class="ident">ItemID</div><div class="operator">:</div> <div class="ident">name</div><div class="operator">,</div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">cluster</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>ListConfigurationProfiles selects list of all configuration profiles from database.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">Storage</div><div class="operator">)</div> <div class="ident">ListConfigurationProfiles</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">ConfigurationProfile</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">profiles</div> <div class="operator">:=</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">ConfigurationProfile</div><div class="operator">{</div><div class="operator">}</div><div class="operator"></div>

	<div class="ident">rows</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connections</div><div class="operator">.</div><div class="ident">Query</div><div class="operator">(</div><div class="literal">&#34;SELECT id, configuration, changed_at, changed_by, description FROM configuration_profile&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Print</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">profiles</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>close the query at function exit</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">defer</div> <div class="keyword">func</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">for</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Next</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="keyword">var</div> <div class="ident">id</div> <div class="ident">int</div><div class="operator"></div>
		<div class="keyword">var</div> <div class="ident">configuration</div> <div class="ident">string</div><div class="operator"></div>
		<div class="keyword">var</div> <div class="ident">changedAt</div> <div class="ident">string</div><div class="operator"></div>
		<div class="keyword">var</div> <div class="ident">changedBy</div> <div class="ident">string</div><div class="operator"></div>
		<div class="keyword">var</div> <div class="ident">description</div> <div class="ident">string</div><div class="operator"></div>

		<div class="ident">err</div> <div class="operator">=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">id</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">configuration</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">changedAt</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">changedBy</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">description</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">==</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">profiles</div> <div class="operator">=</div> <div class="ident">append</div><div class="operator">(</div><div class="ident">profiles</div><div class="operator">,</div> <div class="ident">ConfigurationProfile</div><div class="operator">{</div><div class="ident">ConfigurationID</div><div class="operator">(</div><div class="ident">id</div><div class="operator">)</div><div class="operator">,</div> <div class="ident">configuration</div><div class="operator">,</div> <div class="ident">changedAt</div><div class="operator">,</div> <div class="ident">changedBy</div><div class="operator">,</div> <div class="ident">description</div><div class="operator">}</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div> <div class="keyword">else</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="literal">&#34;error&#34;</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">profiles</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>GetConfigurationProfile selects one configuration profile identified by its ID.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">Storage</div><div class="operator">)</div> <div class="ident">GetConfigurationProfile</div><div class="operator">(</div><div class="ident">id</div> <div class="ident">int</div><div class="operator">)</div> <div class="operator">(</div><div class="ident">ConfigurationProfile</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">var</div> <div class="ident">profile</div> <div class="ident">ConfigurationProfile</div><div class="operator"></div>

	<div class="ident">rows</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connections</div><div class="operator">.</div><div class="ident">Query</div><div class="operator">(</div><div class="literal">&#34;SELECT id, configuration, changed_at, changed_by, description FROM configuration_profile WHERE id = $1&#34;</div><div class="operator">,</div> <div class="ident">id</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">profile</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>close the query at function exit</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">defer</div> <div class="keyword">func</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Next</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="keyword">var</div> <div class="ident">id</div> <div class="ident">int</div><div class="operator"></div>
		<div class="keyword">var</div> <div class="ident">configuration</div> <div class="ident">string</div><div class="operator"></div>
		<div class="keyword">var</div> <div class="ident">changedAt</div> <div class="ident">string</div><div class="operator"></div>
		<div class="keyword">var</div> <div class="ident">changedBy</div> <div class="ident">string</div><div class="operator"></div>
		<div class="keyword">var</div> <div class="ident">description</div> <div class="ident">string</div><div class="operator"></div>

		<div class="ident">err</div> <div class="operator">=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">id</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">configuration</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">changedAt</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">changedBy</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">description</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">==</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">profile</div><div class="operator">.</div><div class="ident">ID</div> <div class="operator">=</div> <div class="ident">ConfigurationID</div><div class="operator">(</div><div class="ident">id</div><div class="operator">)</div><div class="operator"></div>
			<div class="ident">profile</div><div class="operator">.</div><div class="ident">Configuration</div> <div class="operator">=</div> <div class="ident">configuration</div><div class="operator"></div>
			<div class="ident">profile</div><div class="operator">.</div><div class="ident">ChangedAt</div> <div class="operator">=</div> <div class="ident">changedAt</div><div class="operator"></div>
			<div class="ident">profile</div><div class="operator">.</div><div class="ident">ChangedBy</div> <div class="operator">=</div> <div class="ident">changedBy</div><div class="operator"></div>
			<div class="ident">profile</div><div class="operator">.</div><div class="ident">Description</div> <div class="operator">=</div> <div class="ident">description</div><div class="operator"></div>
		<div class="operator">}</div> <div class="keyword">else</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="literal">&#34;error&#34;</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div> <div class="keyword">else</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">profile</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">ItemNotFoundError</div><div class="operator">{</div>
			<div class="ident">ItemID</div><div class="operator">:</div> <div class="ident">id</div><div class="operator">,</div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">profile</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>StoreConfigurationProfile stores a given configuration profile (string ATM) into the database.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">Storage</div><div class="operator">)</div> <div class="ident">StoreConfigurationProfile</div><div class="operator">(</div><div class="ident">username</div> <div class="ident">string</div><div class="operator">,</div> <div class="ident">description</div> <div class="ident">string</div><div class="operator">,</div> <div class="ident">configuration</div> <div class="ident">string</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">ConfigurationProfile</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">var</div> <div class="ident">profiles</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">ConfigurationProfile</div><div class="operator"></div>

	<div class="ident">t</div> <div class="operator">:=</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">statement</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connections</div><div class="operator">.</div><div class="ident">Prepare</div><div class="operator">(</div><div class="literal">&#34;INSERT INTO configuration_profile(configuration, changed_at, changed_by, description) VALUES ($1, $2, $3, $4)&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Print</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">profiles</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>statement has to be closed at function exit</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">defer</div> <div class="keyword">func</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>try to close the statement</p>
</td>
	<td class="code"><pre><code>		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">statement</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>in case of error all we can do is to just log the error</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">statement</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="ident">configuration</div><div class="operator">,</div> <div class="ident">t</div><div class="operator">,</div> <div class="ident">username</div><div class="operator">,</div> <div class="ident">description</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Print</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">profiles</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">ListConfigurationProfiles</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>ChangeConfigurationProfile updates the existing configuration profile specified by its ID.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">Storage</div><div class="operator">)</div> <div class="ident">ChangeConfigurationProfile</div><div class="operator">(</div><div class="ident">id</div> <div class="ident">int</div><div class="operator">,</div> <div class="ident">username</div> <div class="ident">string</div><div class="operator">,</div> <div class="ident">description</div> <div class="ident">string</div><div class="operator">,</div> <div class="ident">configuration</div> <div class="ident">string</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">ConfigurationProfile</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">var</div> <div class="ident">profiles</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">ConfigurationProfile</div><div class="operator"></div>

	<div class="ident">t</div> <div class="operator">:=</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">statement</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connections</div><div class="operator">.</div><div class="ident">Prepare</div><div class="operator">(</div><div class="literal">&#34;UPDATE configuration_profile SET configuration = $1, changed_at = $2, changed_by = $3, description = $4 WHERE id = $5&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Print</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">profiles</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>close the statement at function exit</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">defer</div> <div class="keyword">func</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">statement</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">rowsAffected</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">execStatementAndGetRowsAffected</div><div class="operator">(</div><div class="ident">statement</div><div class="operator">,</div> <div class="ident">configuration</div><div class="operator">,</div> <div class="ident">t</div><div class="operator">,</div> <div class="ident">username</div><div class="operator">,</div> <div class="ident">description</div><div class="operator">,</div> <div class="ident">id</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Print</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">profiles</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">rowsAffected</div> <div class="operator">==</div> <div class="literal">0</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">profiles</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">ItemNotFoundError</div><div class="operator">{</div>
			<div class="ident">ItemID</div><div class="operator">:</div> <div class="ident">id</div><div class="operator">,</div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">ListConfigurationProfiles</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>DeleteConfigurationProfile deletes a configuration profile specified by its name.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">Storage</div><div class="operator">)</div> <div class="ident">DeleteConfigurationProfile</div><div class="operator">(</div><div class="ident">id</div> <div class="ident">int</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">ConfigurationProfile</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">var</div> <div class="ident">profiles</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">ConfigurationProfile</div><div class="operator"></div>

	<div class="ident">statement</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connections</div><div class="operator">.</div><div class="ident">Prepare</div><div class="operator">(</div><div class="literal">&#34;DELETE FROM configuration_profile WHERE id = $1&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Print</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">profiles</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>close the statement at function exit</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">defer</div> <div class="keyword">func</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">statement</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">rowsAffected</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">execStatementAndGetRowsAffected</div><div class="operator">(</div><div class="ident">statement</div><div class="operator">,</div> <div class="ident">id</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Print</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">profiles</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">rowsAffected</div> <div class="operator">==</div> <div class="literal">0</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">profiles</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">ItemNotFoundError</div><div class="operator">{</div>
			<div class="ident">ItemID</div><div class="operator">:</div> <div class="ident">id</div><div class="operator">,</div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">ListConfigurationProfiles</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">Storage</div><div class="operator">)</div> <div class="ident">readClusterConfigurations</div><div class="operator">(</div><div class="ident">rows</div> <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">Rows</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">ClusterConfiguration</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">configurations</div> <div class="operator">:=</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">ClusterConfiguration</div><div class="operator">{</div><div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>close the query at function exit</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">defer</div> <div class="keyword">func</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">for</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Next</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="keyword">var</div> <div class="ident">id</div> <div class="ident">int</div><div class="operator"></div>
		<div class="keyword">var</div> <div class="ident">cluster</div> <div class="ident">string</div><div class="operator"></div>
		<div class="keyword">var</div> <div class="ident">configuration</div> <div class="ident">string</div><div class="operator"></div>
		<div class="keyword">var</div> <div class="ident">changedAt</div> <div class="ident">string</div><div class="operator"></div>
		<div class="keyword">var</div> <div class="ident">changedBy</div> <div class="ident">string</div><div class="operator"></div>
		<div class="keyword">var</div> <div class="ident">active</div> <div class="ident">string</div><div class="operator"></div>
		<div class="keyword">var</div> <div class="ident">reason</div> <div class="ident">string</div><div class="operator"></div>

		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">id</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">cluster</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">configuration</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">changedAt</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">changedBy</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">active</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">reason</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">==</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">configurations</div> <div class="operator">=</div> <div class="ident">append</div><div class="operator">(</div><div class="ident">configurations</div><div class="operator">,</div> <div class="ident">ClusterConfiguration</div><div class="operator">{</div><div class="ident">ClusterConfigurationID</div><div class="operator">(</div><div class="ident">id</div><div class="operator">)</div><div class="operator">,</div> <div class="ident">cluster</div><div class="operator">,</div> <div class="ident">configuration</div><div class="operator">,</div> <div class="ident">changedAt</div><div class="operator">,</div> <div class="ident">changedBy</div><div class="operator">,</div> <div class="ident">active</div><div class="operator">,</div> <div class="ident">reason</div><div class="operator">}</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div> <div class="keyword">else</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="literal">&#34;error&#34;</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">configurations</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>ListAllClusterConfigurations selects all cluster configurations from the database.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">Storage</div><div class="operator">)</div> <div class="ident">ListAllClusterConfigurations</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">ClusterConfiguration</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">rows</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connections</div><div class="operator">.</div><div class="ident">Query</div><div class="operator">(</div><div class="literal">`
SELECT operator_configuration.id, cluster.name, configuration, changed_at, changed_by, active, reason
  FROM operator_configuration JOIN cluster
    ON (cluster.id = operator_configuration.cluster)
ORDER BY operator_configuration.id`</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Print</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">ClusterConfiguration</div><div class="operator">{</div><div class="operator">}</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">readClusterConfigurations</div><div class="operator">(</div><div class="ident">rows</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>ListClusterConfiguration selects cluster configuration from the database for the specified cluster.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">Storage</div><div class="operator">)</div> <div class="ident">ListClusterConfiguration</div><div class="operator">(</div><div class="ident">cluster</div> <div class="ident">string</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">ClusterConfiguration</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">if</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">GetClusterByName</div><div class="operator">(</div><div class="ident">cluster</div><div class="operator">)</div><div class="operator">;</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">rows</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connections</div><div class="operator">.</div><div class="ident">Query</div><div class="operator">(</div><div class="literal">`
SELECT operator_configuration.id, cluster.name, configuration, changed_at, changed_by, active, reason
  FROM operator_configuration JOIN cluster
    ON (cluster.id = operator_configuration.cluster)
 WHERE cluster.name = $1`</div><div class="operator">,</div> <div class="ident">cluster</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Print</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">ClusterConfiguration</div><div class="operator">{</div><div class="operator">}</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">readClusterConfigurations</div><div class="operator">(</div><div class="ident">rows</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>GetClusterConfigurationByID reads cluster configuration for the specified configuration ID.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">Storage</div><div class="operator">)</div> <div class="ident">GetClusterConfigurationByID</div><div class="operator">(</div><div class="ident">id</div> <div class="ident">int64</div><div class="operator">)</div> <div class="operator">(</div><div class="ident">string</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">var</div> <div class="ident">configuration</div> <div class="ident">string</div><div class="operator"></div>

	<div class="ident">row</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connections</div><div class="operator">.</div><div class="ident">Query</div><div class="operator">(</div><div class="literal">`
SELECT configuration_profile.configuration
  FROM operator_configuration JOIN configuration_profile
    ON (configuration_profile.id = operator_configuration.configuration)
 WHERE operator_configuration.id = $1`</div><div class="operator">,</div> <div class="ident">id</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Print</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">configuration</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>close the query at function exit</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">defer</div> <div class="keyword">func</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">row</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">row</div><div class="operator">.</div><div class="ident">Next</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="ident">err</div> <div class="operator">=</div> <div class="ident">row</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">configuration</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="literal">&#34;error&#34;</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">configuration</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">configuration</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">ItemNotFoundError</div><div class="operator">{</div>
		<div class="ident">ItemID</div><div class="operator">:</div> <div class="ident">id</div><div class="operator">,</div>
	<div class="operator">}</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>GetClusterActiveConfiguration reads one active configuration for the selected cluster.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">Storage</div><div class="operator">)</div> <div class="ident">GetClusterActiveConfiguration</div><div class="operator">(</div><div class="ident">cluster</div> <div class="ident">string</div><div class="operator">)</div> <div class="operator">(</div><div class="ident">string</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">var</div> <div class="ident">configuration</div> <div class="ident">string</div><div class="operator"></div>

	<div class="ident">row</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connections</div><div class="operator">.</div><div class="ident">Query</div><div class="operator">(</div><div class="literal">`
SELECT configuration_profile.configuration
  FROM operator_configuration, cluster, configuration_profile
 WHERE cluster.id = operator_configuration.cluster
   AND configuration_profile.id = operator_configuration.configuration
   AND operator_configuration.active = &#39;1&#39; AND cluster.name = $1
 LIMIT 1`</div><div class="operator">,</div> <div class="ident">cluster</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Print</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">configuration</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>query has to be closed at function exit</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">defer</div> <div class="keyword">func</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>try to close the query</p>
</td>
	<td class="code"><pre><code>		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">row</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>in case of error all we can do is to just log the error</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">row</div><div class="operator">.</div><div class="ident">Next</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="ident">err</div> <div class="operator">=</div> <div class="ident">row</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">configuration</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="literal">&#34;error&#34;</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">configuration</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">configuration</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">ItemNotFoundError</div><div class="operator">{</div>
		<div class="ident">ItemID</div><div class="operator">:</div> <div class="ident">cluster</div><div class="operator">,</div>
	<div class="operator">}</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>GetConfigurationIDForCluster reads the ID for the specified cluster name.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">Storage</div><div class="operator">)</div> <div class="ident">GetConfigurationIDForCluster</div><div class="operator">(</div><div class="ident">cluster</div> <div class="ident">string</div><div class="operator">)</div> <div class="operator">(</div><div class="ident">int</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">rows</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connections</div><div class="operator">.</div><div class="ident">Query</div><div class="operator">(</div><div class="literal">`
SELECT operator_configuration.id
  FROM operator_configuration, cluster
    ON cluster.id = operator_configuration.cluster
 WHERE cluster.name = $1`</div><div class="operator">,</div> <div class="ident">cluster</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="literal">0</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>query has to be closed at function exit</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">defer</div> <div class="keyword">func</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>try to close the query</p>
</td>
	<td class="code"><pre><code>		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>in case of error all we can do is to just log the error</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Next</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="keyword">var</div> <div class="ident">id</div> <div class="ident">int</div><div class="operator"></div>

		<div class="ident">err</div> <div class="operator">=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">id</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">id</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="literal">0</div><div class="operator">,</div> <div class="ident">errors</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="literal">&#34;Unknown operator name provided&#34;</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>InsertNewConfigurationProfile inserts new configuration profile into a database (in transaction).</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">Storage</div><div class="operator">)</div> <div class="ident">InsertNewConfigurationProfile</div><div class="operator">(</div><div class="ident">tx</div> <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">Tx</div><div class="operator">,</div> <div class="ident">configuration</div> <div class="ident">string</div><div class="operator">,</div> <div class="ident">username</div> <div class="ident">string</div><div class="operator">,</div> <div class="ident">description</div> <div class="ident">string</div><div class="operator">)</div> <div class="ident">bool</div> <div class="operator">{</div>
	<div class="ident">t</div> <div class="operator">:=</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">statement</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">tx</div><div class="operator">.</div><div class="ident">Prepare</div><div class="operator">(</div><div class="literal">&#34;INSERT INTO configuration_profile(configuration, changed_at, changed_by, description) VALUES ($1, $2, $3, $4)&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">false</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>statement has to be closed at function exit</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">defer</div> <div class="keyword">func</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>try to close the statement</p>
</td>
	<td class="code"><pre><code>		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">statement</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>in case of error all we can do is to just log the error</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">statement</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="ident">configuration</div><div class="operator">,</div> <div class="ident">t</div><div class="operator">,</div> <div class="ident">username</div><div class="operator">,</div> <div class="ident">description</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">false</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">true</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>SelectConfigurationProfileID selects the ID of lately inserted/created configuration profile. To be used in transaction.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">Storage</div><div class="operator">)</div> <div class="ident">SelectConfigurationProfileID</div><div class="operator">(</div><div class="ident">tx</div> <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">Tx</div><div class="operator">)</div> <div class="operator">(</div><div class="ident">int</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">var</div> <div class="ident">rows</div> <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">Rows</div><div class="operator"></div>
	<div class="keyword">var</div> <div class="ident">err</div> <div class="ident">error</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>We need to get the ID from the last insert. Unfortunately it seems there is not
one existing solution that works for all databases.</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">switch</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">driver</div> <div class="operator">{</div>
	<div class="keyword">case</div> <div class="literal">&#34;sqlite3&#34;</div><div class="operator">:</div>
		<div class="ident">rows</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">tx</div><div class="operator">.</div><div class="ident">Query</div><div class="operator">(</div><div class="literal">`SELECT rowid FROM configuration_profile ORDER BY rowid DESC limit 1`</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">case</div> <div class="literal">&#34;postgres&#34;</div><div class="operator">:</div>
		<div class="ident">rows</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">tx</div><div class="operator">.</div><div class="ident">Query</div><div class="operator">(</div><div class="literal">`SELECT currval(&#39;configuration_profile_id_seq&#39;)`</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">default</div><div class="operator">:</div>
		<div class="keyword">return</div> <div class="operator">-</div><div class="literal">1</div><div class="operator">,</div> <div class="ident">errors</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="literal">&#34;unknown DB driver:&#34;</div> <div class="operator">&#43;</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">driver</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Print</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="operator">-</div><div class="literal">1</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>query has to be closed at function exit</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">defer</div> <div class="keyword">func</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>try to close the query</p>
</td>
	<td class="code"><pre><code>		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>in case of error all we can do is to just log the error</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Next</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="keyword">var</div> <div class="ident">configurationID</div> <div class="ident">int</div><div class="operator"></div>
		<div class="ident">err</div> <div class="operator">=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">configurationID</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="keyword">return</div> <div class="operator">-</div><div class="literal">1</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Printf</div><div class="operator">(</div><div class="literal">&#34;Configuration stored under ID=%d\n&#34;</div><div class="operator">,</div> <div class="ident">configurationID</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">configurationID</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="operator">-</div><div class="literal">1</div><div class="operator">,</div> <div class="ident">errors</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="literal">&#34;can not retrieve last configuration ID&#34;</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>DeactivatePreviousConfigurations deactivate all previous configurations for the specified trigger.
To be called inside transaction.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">Storage</div><div class="operator">)</div> <div class="ident">DeactivatePreviousConfigurations</div><div class="operator">(</div><div class="ident">tx</div> <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">Tx</div><div class="operator">,</div> <div class="ident">clusterID</div> <div class="ident">ClusterID</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
	<div class="ident">statement</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">tx</div><div class="operator">.</div><div class="ident">Prepare</div><div class="operator">(</div><div class="literal">&#34;UPDATE operator_configuration SET active=0 WHERE cluster = $1&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>statement has to be closed at function exit</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">defer</div> <div class="keyword">func</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>try to close the statement</p>
</td>
	<td class="code"><pre><code>		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">statement</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>in case of error all we can do is to just log the error</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">statement</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="ident">clusterID</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">==</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Printf</div><div class="operator">(</div><div class="literal">&#34;All previous configuration has been deactivated for clusterID %d\n&#34;</div><div class="operator">,</div> <div class="ident">clusterID</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>InsertNewOperatorConfiguration inserts the new configuration for selected operator/cluster.
To be called inside transaction.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">Storage</div><div class="operator">)</div> <div class="ident">InsertNewOperatorConfiguration</div><div class="operator">(</div><div class="ident">tx</div> <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">Tx</div><div class="operator">,</div> <div class="ident">clusterID</div> <div class="ident">ClusterID</div><div class="operator">,</div> <div class="ident">configurationID</div> <div class="ident">int</div><div class="operator">,</div> <div class="ident">username</div> <div class="ident">string</div><div class="operator">,</div> <div class="ident">reason</div> <div class="ident">string</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
	<div class="ident">t</div> <div class="operator">:=</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">statement</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">tx</div><div class="operator">.</div><div class="ident">Prepare</div><div class="operator">(</div><div class="literal">&#34;INSERT INTO operator_configuration(cluster, configuration, changed_at, changed_by, active, reason) VALUES ($1, $2, $3, $4, $5, $6)&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>statement has to be closed at function exit</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">defer</div> <div class="keyword">func</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>try to close the statement</p>
</td>
	<td class="code"><pre><code>		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">statement</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>in case of error all we can do is to just log the error</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">statement</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="ident">clusterID</div><div class="operator">,</div> <div class="ident">configurationID</div><div class="operator">,</div> <div class="ident">t</div><div class="operator">,</div> <div class="ident">username</div><div class="operator">,</div> <div class="literal">&#34;1&#34;</div><div class="operator">,</div> <div class="ident">reason</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">==</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Printf</div><div class="operator">(</div><div class="literal">&#34;New operator configuration %d has been assigned to cluster %d\n&#34;</div><div class="operator">,</div> <div class="ident">configurationID</div><div class="operator">,</div> <div class="ident">clusterID</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>CreateClusterConfiguration creates new configuration for specified cluster.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">Storage</div><div class="operator">)</div> <div class="ident">CreateClusterConfiguration</div><div class="operator">(</div><div class="ident">cluster</div> <div class="ident">string</div><div class="operator">,</div> <div class="ident">username</div> <div class="ident">string</div><div class="operator">,</div> <div class="ident">reason</div> <div class="ident">string</div><div class="operator">,</div> <div class="ident">description</div><div class="operator">,</div> <div class="ident">configuration</div> <div class="ident">string</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">ClusterConfiguration</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>retrieve cluster ID</p>
</td>
	<td class="code"><pre><code>	<div class="ident">clusterInfo</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">GetClusterByName</div><div class="operator">(</div><div class="ident">cluster</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Print</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">ClusterConfiguration</div><div class="operator">{</div><div class="operator">}</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">clusterID</div> <div class="operator">:=</div> <div class="ident">clusterInfo</div><div class="operator">.</div><div class="ident">ID</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>begin transaction</p>
</td>
	<td class="code"><pre><code>	<div class="ident">tx</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connections</div><div class="operator">.</div><div class="ident">Begin</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Print</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="literal">&#34;Transaction failed&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">ClusterConfiguration</div><div class="operator">{</div><div class="operator">}</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>insert new configuration profile</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">if</div> <div class="operator">!</div><div class="ident">storage</div><div class="operator">.</div><div class="ident">InsertNewConfigurationProfile</div><div class="operator">(</div><div class="ident">tx</div><div class="operator">,</div> <div class="ident">configuration</div><div class="operator">,</div> <div class="ident">username</div><div class="operator">,</div> <div class="ident">description</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Print</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">_</div> <div class="operator">=</div> <div class="ident">tx</div><div class="operator">.</div><div class="ident">Rollback</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">ClusterConfiguration</div><div class="operator">{</div><div class="operator">}</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>retrieve configuration ID for newly created configuration</p>
</td>
	<td class="code"><pre><code>	<div class="ident">configurationID</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">SelectConfigurationProfileID</div><div class="operator">(</div><div class="ident">tx</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Print</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">_</div> <div class="operator">=</div> <div class="ident">tx</div><div class="operator">.</div><div class="ident">Rollback</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">ClusterConfiguration</div><div class="operator">{</div><div class="operator">}</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>deactivate all previous configurations</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">DeactivatePreviousConfigurations</div><div class="operator">(</div><div class="ident">tx</div><div class="operator">,</div> <div class="ident">clusterID</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Print</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">_</div> <div class="operator">=</div> <div class="ident">tx</div><div class="operator">.</div><div class="ident">Rollback</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">ClusterConfiguration</div><div class="operator">{</div><div class="operator">}</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>and insert new one that will be activated</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">InsertNewOperatorConfiguration</div><div class="operator">(</div><div class="ident">tx</div><div class="operator">,</div> <div class="ident">clusterID</div><div class="operator">,</div> <div class="ident">configurationID</div><div class="operator">,</div> <div class="ident">username</div><div class="operator">,</div> <div class="ident">reason</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Print</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">_</div> <div class="operator">=</div> <div class="ident">tx</div><div class="operator">.</div><div class="ident">Rollback</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">ClusterConfiguration</div><div class="operator">{</div><div class="operator">}</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>end the transaction</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">tx</div><div class="operator">.</div><div class="ident">Commit</div><div class="operator">(</div><div class="operator">)</div><div class="operator">;</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Print</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">ClusterConfiguration</div><div class="operator">{</div><div class="operator">}</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">ListClusterConfiguration</div><div class="operator">(</div><div class="ident">cluster</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>EnableClusterConfiguration enables the specified cluster configuration (set the 'active' flag).</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">Storage</div><div class="operator">)</div> <div class="ident">EnableClusterConfiguration</div><div class="operator">(</div><div class="ident">cluster</div> <div class="ident">string</div><div class="operator">,</div> <div class="ident">username</div> <div class="ident">string</div><div class="operator">,</div> <div class="ident">reason</div> <div class="ident">string</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">ClusterConfiguration</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">id</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">GetConfigurationIDForCluster</div><div class="operator">(</div><div class="ident">cluster</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">ClusterConfiguration</div><div class="operator">{</div><div class="operator">}</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">statement</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connections</div><div class="operator">.</div><div class="ident">Prepare</div><div class="operator">(</div><div class="literal">&#34;UPDATE operator_configuration SET active=1, changed_at = $1, changed_by = $2, reason = $3 WHERE id = $4&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">ClusterConfiguration</div><div class="operator">{</div><div class="operator">}</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>statement has to be closed at function exit</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">defer</div> <div class="keyword">func</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>try to close the statement</p>
</td>
	<td class="code"><pre><code>		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">statement</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>in case of error all we can do is to just log the error</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">t</div> <div class="operator">:=</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">statement</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">username</div><div class="operator">,</div> <div class="ident">reason</div><div class="operator">,</div> <div class="ident">id</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">ClusterConfiguration</div><div class="operator">{</div><div class="operator">}</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">ListClusterConfiguration</div><div class="operator">(</div><div class="ident">cluster</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>DisableClusterConfiguration disables the specified cluster configuration (reset the 'active' flag).
TODO: copy &amp; paste, needs to be refactored later</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">Storage</div><div class="operator">)</div> <div class="ident">DisableClusterConfiguration</div><div class="operator">(</div><div class="ident">cluster</div> <div class="ident">string</div><div class="operator">,</div> <div class="ident">username</div> <div class="ident">string</div><div class="operator">,</div> <div class="ident">reason</div> <div class="ident">string</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">ClusterConfiguration</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">id</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">GetConfigurationIDForCluster</div><div class="operator">(</div><div class="ident">cluster</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">ClusterConfiguration</div><div class="operator">{</div><div class="operator">}</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="ident">statement</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connections</div><div class="operator">.</div><div class="ident">Prepare</div><div class="operator">(</div><div class="literal">&#34;UPDATE operator_configuration SET active=0, changed_at = $1, changed_by = $2, reason = $3 WHERE id = $4&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">ClusterConfiguration</div><div class="operator">{</div><div class="operator">}</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>statement has to be closed at function exit</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">defer</div> <div class="keyword">func</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>try to close the statement</p>
</td>
	<td class="code"><pre><code>		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">statement</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>in case of error all we can do is to just log the error</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">t</div> <div class="operator">:=</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">statement</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">username</div><div class="operator">,</div> <div class="ident">reason</div><div class="operator">,</div> <div class="ident">id</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">ClusterConfiguration</div><div class="operator">{</div><div class="operator">}</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">ListClusterConfiguration</div><div class="operator">(</div><div class="ident">cluster</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>EnableOrDisableClusterConfigurationByID enables or disables the specified cluster configuration (set or reset the 'active' flag).
Please see also EnableClusterConfiguration and DisableClusterConfiguration</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">Storage</div><div class="operator">)</div> <div class="ident">EnableOrDisableClusterConfigurationByID</div><div class="operator">(</div><div class="ident">id</div> <div class="ident">int64</div><div class="operator">,</div> <div class="ident">active</div> <div class="ident">string</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
	<div class="ident">statement</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connections</div><div class="operator">.</div><div class="ident">Prepare</div><div class="operator">(</div><div class="literal">&#34;UPDATE operator_configuration SET active = $1, changed_at = $2 WHERE id = $3&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>statement has to be closed at function exit</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">defer</div> <div class="keyword">func</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>try to close the statement</p>
</td>
	<td class="code"><pre><code>		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">statement</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>in case of error all we can do is to just log the error</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">t</div> <div class="operator">:=</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">rowsAffected</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">execStatementAndGetRowsAffected</div><div class="operator">(</div><div class="ident">statement</div><div class="operator">,</div> <div class="ident">active</div><div class="operator">,</div> <div class="ident">t</div><div class="operator">,</div> <div class="ident">id</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">rowsAffected</div> <div class="operator">==</div> <div class="literal">0</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="operator">&amp;</div><div class="ident">ItemNotFoundError</div><div class="operator">{</div>
			<div class="ident">ItemID</div><div class="operator">:</div> <div class="ident">id</div><div class="operator">,</div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>DeleteClusterConfigurationByID deletes cluster configuration specified by its ID.
TODO: copy &amp; paste, needs to be refactored later</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">Storage</div><div class="operator">)</div> <div class="ident">DeleteClusterConfigurationByID</div><div class="operator">(</div><div class="ident">id</div> <div class="ident">int64</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
	<div class="ident">statement</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connections</div><div class="operator">.</div><div class="ident">Prepare</div><div class="operator">(</div><div class="literal">&#34;DELETE FROM operator_configuration WHERE id = $1&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>statement has to be closed at function exit</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">defer</div> <div class="keyword">func</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>try to close the statement</p>
</td>
	<td class="code"><pre><code>		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">statement</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>in case of error all we can do is to just log the error</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">rowsAffected</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">execStatementAndGetRowsAffected</div><div class="operator">(</div><div class="ident">statement</div><div class="operator">,</div> <div class="ident">id</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">rowsAffected</div> <div class="operator">==</div> <div class="literal">0</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="operator">&amp;</div><div class="ident">ItemNotFoundError</div><div class="operator">{</div>
			<div class="ident">ItemID</div><div class="operator">:</div> <div class="ident">id</div><div class="operator">,</div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">Storage</div><div class="operator">)</div> <div class="ident">getTriggers</div><div class="operator">(</div><div class="ident">rows</div> <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">Rows</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">Trigger</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">triggers</div> <div class="operator">:=</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">Trigger</div><div class="operator">{</div><div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>close the query at function exit</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">defer</div> <div class="keyword">func</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">for</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Next</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="keyword">var</div> <div class="ident">trigger</div> <div class="ident">Trigger</div><div class="operator"></div>

		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">trigger</div><div class="operator">.</div><div class="ident">ID</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">trigger</div><div class="operator">.</div><div class="ident">Type</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">trigger</div><div class="operator">.</div><div class="ident">Cluster</div><div class="operator">,</div>
			<div class="operator">&amp;</div><div class="ident">trigger</div><div class="operator">.</div><div class="ident">Reason</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">trigger</div><div class="operator">.</div><div class="ident">Link</div><div class="operator">,</div>
			<div class="operator">&amp;</div><div class="ident">trigger</div><div class="operator">.</div><div class="ident">TriggeredAt</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">trigger</div><div class="operator">.</div><div class="ident">TriggeredBy</div><div class="operator">,</div>
			<div class="operator">&amp;</div><div class="ident">trigger</div><div class="operator">.</div><div class="ident">Parameters</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">trigger</div><div class="operator">.</div><div class="ident">Active</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">trigger</div><div class="operator">.</div><div class="ident">AckedAt</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">==</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">triggers</div> <div class="operator">=</div> <div class="ident">append</div><div class="operator">(</div><div class="ident">triggers</div><div class="operator">,</div> <div class="ident">trigger</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div> <div class="keyword">else</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="literal">&#34;error&#34;</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">triggers</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>GetTriggerByID selects all informations about the trigger specified by its ID.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">Storage</div><div class="operator">)</div> <div class="ident">GetTriggerByID</div><div class="operator">(</div><div class="ident">id</div> <div class="ident">int64</div><div class="operator">)</div> <div class="operator">(</div><div class="ident">Trigger</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">rows</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connections</div><div class="operator">.</div><div class="ident">Query</div><div class="operator">(</div><div class="literal">`
SELECT trigger.id, trigger_type.type, cluster.name,
       trigger.reason, trigger.link, trigger.triggered_at, trigger.triggered_by,
       trigger.parameters, trigger.active, trigger.acked_at
  FROM trigger JOIN trigger_type ON trigger.type=trigger_type.id
               JOIN cluster ON trigger.cluster=cluster.id
 WHERE trigger.id = $1`</div><div class="operator">,</div> <div class="ident">id</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">Trigger</div><div class="operator">{</div><div class="operator">}</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">triggers</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">getTriggers</div><div class="operator">(</div><div class="ident">rows</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">Trigger</div><div class="operator">{</div><div class="operator">}</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">len</div><div class="operator">(</div><div class="ident">triggers</div><div class="operator">)</div> <div class="operator">&gt;=</div> <div class="literal">1</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">triggers</div><div class="operator">[</div><div class="literal">0</div><div class="operator">]</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">Trigger</div><div class="operator">{</div><div class="operator">}</div><div class="operator">,</div> <div class="ident">ErrNoSuchObj</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">execStatementAndGetRowsAffected</div><div class="operator">(</div><div class="ident">statement</div> <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">Stmt</div><div class="operator">,</div> <div class="ident">args</div> <div class="operator">...</div><div class="keyword">interface</div><div class="operator">{</div><div class="operator">}</div><div class="operator">)</div> <div class="operator">(</div><div class="ident">int64</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">res</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">statement</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="ident">args</div><div class="operator">...</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="literal">0</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">rowsAffected</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">res</div><div class="operator">.</div><div class="ident">RowsAffected</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="literal">0</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">rowsAffected</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>DeleteTriggerByID deletes trigger specified by its ID
returns ItemNotFoundError if trigger didn't exist</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">Storage</div><div class="operator">)</div> <div class="ident">DeleteTriggerByID</div><div class="operator">(</div><div class="ident">id</div> <div class="ident">int64</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
	<div class="ident">statement</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connections</div><div class="operator">.</div><div class="ident">Prepare</div><div class="operator">(</div><div class="literal">`
DELETE FROM trigger WHERE trigger.id = $1`</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Print</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>statement has to be closed at function exit</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">defer</div> <div class="keyword">func</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>try to close the statement</p>
</td>
	<td class="code"><pre><code>		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">statement</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>in case of error all we can do is to just log the error</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">rowsAffected</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">execStatementAndGetRowsAffected</div><div class="operator">(</div><div class="ident">statement</div><div class="operator">,</div> <div class="ident">id</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Print</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>non-existent trigger ID has been used</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">if</div> <div class="ident">rowsAffected</div> <div class="operator">==</div> <div class="literal">0</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>convert ID (numeric value) to string for proper logging</p>
</td>
	<td class="code"><pre><code>		<div class="ident">IDstr</div> <div class="operator">:=</div> <div class="ident">strconv</div><div class="operator">.</div><div class="ident">Itoa</div><div class="operator">(</div><div class="ident">int</div><div class="operator">(</div><div class="ident">id</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="operator">&amp;</div><div class="ident">ItemNotFoundError</div><div class="operator">{</div>
			<div class="ident">ItemID</div><div class="operator">:</div> <div class="ident">IDstr</div><div class="operator">,</div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>ChangeStateOfTriggerByID change the state ('active', 'inactive') of trigger specified by its ID.
returns ItemNotFoundError if there weren't rows with such id</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">Storage</div><div class="operator">)</div> <div class="ident">ChangeStateOfTriggerByID</div><div class="operator">(</div><div class="ident">id</div> <div class="ident">int64</div><div class="operator">,</div> <div class="ident">active</div> <div class="ident">int</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
	<div class="ident">statement</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connections</div><div class="operator">.</div><div class="ident">Prepare</div><div class="operator">(</div><div class="literal">`
UPDATE trigger SET active = $1 WHERE trigger.id = $2`</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>statement has to be closed at function exit</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">defer</div> <div class="keyword">func</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>try to close the statement</p>
</td>
	<td class="code"><pre><code>		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">statement</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>in case of error all we can do is to just log the error</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">rowsAffected</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">execStatementAndGetRowsAffected</div><div class="operator">(</div><div class="ident">statement</div><div class="operator">,</div> <div class="ident">active</div><div class="operator">,</div> <div class="ident">id</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Print</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>non-existent trigger ID has been used</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">if</div> <div class="ident">rowsAffected</div> <div class="operator">==</div> <div class="literal">0</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>convert ID (numeric value) to string for proper logging</p>
</td>
	<td class="code"><pre><code>		<div class="ident">IDstr</div> <div class="operator">:=</div> <div class="ident">strconv</div><div class="operator">.</div><div class="ident">Itoa</div><div class="operator">(</div><div class="ident">int</div><div class="operator">(</div><div class="ident">id</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="operator">&amp;</div><div class="ident">ItemNotFoundError</div><div class="operator">{</div>
			<div class="ident">ItemID</div><div class="operator">:</div> <div class="ident">IDstr</div><div class="operator">,</div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>ListAllTriggers selects all triggers from the database.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">Storage</div><div class="operator">)</div> <div class="ident">ListAllTriggers</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">Trigger</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">triggers</div> <div class="operator">:=</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">Trigger</div><div class="operator">{</div><div class="operator">}</div><div class="operator"></div>

	<div class="ident">rows</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connections</div><div class="operator">.</div><div class="ident">Query</div><div class="operator">(</div><div class="literal">`
SELECT trigger.id, trigger_type.type, cluster.name,
       trigger.reason, trigger.link, trigger.triggered_at, trigger.triggered_by,
       trigger.parameters, trigger.active, trigger.acked_at
FROM trigger JOIN trigger_type ON trigger.type=trigger_type.id
               JOIN cluster ON trigger.cluster=cluster.id
ORDER BY trigger.id`</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">triggers</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">getTriggers</div><div class="operator">(</div><div class="ident">rows</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>ListClusterTriggers selects all triggers assigned to the specified cluster.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">Storage</div><div class="operator">)</div> <div class="ident">ListClusterTriggers</div><div class="operator">(</div><div class="ident">clusterName</div> <div class="ident">string</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">Trigger</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">triggers</div> <div class="operator">:=</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">Trigger</div><div class="operator">{</div><div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check that cluster exist</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">if</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">GetClusterByName</div><div class="operator">(</div><div class="ident">clusterName</div><div class="operator">)</div><div class="operator">;</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">triggers</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">rows</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connections</div><div class="operator">.</div><div class="ident">Query</div><div class="operator">(</div><div class="literal">`
SELECT trigger.id, trigger_type.type, cluster.name,
       trigger.reason, trigger.link, trigger.triggered_at, trigger.triggered_by,
       trigger.parameters, trigger.active, trigger.acked_at
  FROM trigger JOIN trigger_type ON trigger.type=trigger_type.id
               JOIN cluster ON trigger.cluster=cluster.id
 WHERE cluster.name = $1
 ORDER BY trigger.id`</div><div class="operator">,</div> <div class="ident">clusterName</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">triggers</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">getTriggers</div><div class="operator">(</div><div class="ident">rows</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>ListActiveClusterTriggers selects all active triggers assigned to the specified cluster.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">Storage</div><div class="operator">)</div> <div class="ident">ListActiveClusterTriggers</div><div class="operator">(</div><div class="ident">clusterName</div> <div class="ident">string</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">Trigger</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">triggers</div> <div class="operator">:=</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">Trigger</div><div class="operator">{</div><div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check that cluster exist</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">if</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">GetClusterByName</div><div class="operator">(</div><div class="ident">clusterName</div><div class="operator">)</div><div class="operator">;</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">triggers</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">rows</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connections</div><div class="operator">.</div><div class="ident">Query</div><div class="operator">(</div><div class="literal">`
SELECT trigger.id, trigger_type.type, cluster.name,
       trigger.reason, trigger.link, trigger.triggered_at, trigger.triggered_by,
       trigger.parameters, trigger.active, trigger.acked_at
  FROM trigger JOIN trigger_type ON trigger.type=trigger_type.id
               JOIN cluster ON trigger.cluster=cluster.id
 WHERE trigger.active = 1
   AND cluster.name = $1`</div><div class="operator">,</div> <div class="ident">clusterName</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">triggers</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">getTriggers</div><div class="operator">(</div><div class="ident">rows</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>GetTriggerID select ID for specified trigger type (name).</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">Storage</div><div class="operator">)</div> <div class="ident">GetTriggerID</div><div class="operator">(</div><div class="ident">triggerType</div> <div class="ident">string</div><div class="operator">)</div> <div class="operator">(</div><div class="ident">int</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">var</div> <div class="ident">id</div> <div class="ident">int</div><div class="operator"></div>

	<div class="ident">rows</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connections</div><div class="operator">.</div><div class="ident">Query</div><div class="operator">(</div><div class="literal">&#34;SELECT id FROM trigger_type WHERE type = $1&#34;</div><div class="operator">,</div> <div class="ident">triggerType</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="literal">0</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>rows has to be closed at function exit</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">defer</div> <div class="keyword">func</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>try to close the statement</p>
</td>
	<td class="code"><pre><code>		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>in case of error all we can do is to just log the error</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Next</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>

		<div class="ident">err</div> <div class="operator">=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">id</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">==</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Printf</div><div class="operator">(</div><div class="literal">&#34;Trigger type %s has id %d\n&#34;</div><div class="operator">,</div> <div class="ident">triggerType</div><div class="operator">,</div> <div class="ident">id</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div> <div class="keyword">else</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="literal">&#34;error&#34;</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div> <div class="keyword">else</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="literal">0</div><div class="operator">,</div> <div class="ident">errors</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="literal">&#34;Unknown trigger type provided&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">id</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>NewTrigger constructs new trigger in a database.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">Storage</div><div class="operator">)</div> <div class="ident">NewTrigger</div><div class="operator">(</div><div class="ident">clusterName</div> <div class="ident">string</div><div class="operator">,</div> <div class="ident">triggerType</div> <div class="ident">string</div><div class="operator">,</div> <div class="ident">userName</div> <div class="ident">string</div><div class="operator">,</div> <div class="ident">reason</div> <div class="ident">string</div><div class="operator">,</div> <div class="ident">link</div> <div class="ident">string</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>retrieve cluster ID</p>
</td>
	<td class="code"><pre><code>	<div class="ident">clusterInfo</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">GetClusterByName</div><div class="operator">(</div><div class="ident">clusterName</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">clusterID</div> <div class="operator">:=</div> <div class="ident">clusterInfo</div><div class="operator">.</div><div class="ident">ID</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Print</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">triggerTypeID</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">GetTriggerID</div><div class="operator">(</div><div class="ident">triggerType</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Print</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="ident">t</div> <div class="operator">:=</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">ackedAt</div> <div class="operator">:=</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Unix</div><div class="operator">(</div><div class="literal">0</div><div class="operator">,</div> <div class="literal">0</div><div class="operator">)</div><div class="operator">.</div><div class="ident">UTC</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">statement</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connections</div><div class="operator">.</div><div class="ident">Prepare</div><div class="operator">(</div><div class="literal">&#34;INSERT INTO trigger(type, cluster, reason, link, triggered_at, triggered_by, parameters, active, acked_at) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Print</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>statement has to be closed at function exit</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">defer</div> <div class="keyword">func</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>try to close the statement</p>
</td>
	<td class="code"><pre><code>		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">statement</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>in case of error all we can do is to just log the error</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">statement</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="ident">triggerTypeID</div><div class="operator">,</div> <div class="ident">clusterID</div><div class="operator">,</div> <div class="ident">reason</div><div class="operator">,</div> <div class="ident">link</div><div class="operator">,</div> <div class="ident">t</div><div class="operator">,</div> <div class="ident">userName</div><div class="operator">,</div> <div class="literal">&#34;&#34;</div><div class="operator">,</div> <div class="literal">1</div><div class="operator">,</div> <div class="ident">ackedAt</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Print</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>NewTriggerType inserts a trigger_type object in the database</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">Storage</div><div class="operator">)</div> <div class="ident">NewTriggerType</div><div class="operator">(</div><div class="ident">ttype</div> <div class="ident">string</div><div class="operator">,</div> <div class="ident">description</div> <div class="ident">string</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
	<div class="ident">statement</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connections</div><div class="operator">.</div><div class="ident">Prepare</div><div class="operator">(</div><div class="literal">&#34;INSERT INTO trigger_type(type, description) VALUES ($1, $2)&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Print</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>statement has to be closed at function exit</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">defer</div> <div class="keyword">func</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>try to close the statement</p>
</td>
	<td class="code"><pre><code>		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">statement</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>in case of error all we can do is to just log the error</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">statement</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="ident">ttype</div><div class="operator">,</div> <div class="ident">description</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Print</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>AckTrigger sets a timestamp to the selected trigger + updates the 'active' flag.
and returns error if trigger wasn't found</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">Storage</div><div class="operator">)</div> <div class="ident">AckTrigger</div><div class="operator">(</div><div class="ident">clusterName</div> <div class="ident">string</div><div class="operator">,</div> <div class="ident">triggerID</div> <div class="ident">int64</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
	<div class="ident">t</div> <div class="operator">:=</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>retrieve cluster ID</p>
</td>
	<td class="code"><pre><code>	<div class="ident">clusterInfo</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">GetClusterByName</div><div class="operator">(</div><div class="ident">clusterName</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">clusterID</div> <div class="operator">:=</div> <div class="ident">clusterInfo</div><div class="operator">.</div><div class="ident">ID</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">statement</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connections</div><div class="operator">.</div><div class="ident">Prepare</div><div class="operator">(</div><div class="literal">&#34;UPDATE trigger SET acked_at = $1, active=0 WHERE cluster = $2 AND id = $3&#34;</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>statement has to be closed at function exit</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">defer</div> <div class="keyword">func</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>try to close the statement</p>
</td>
	<td class="code"><pre><code>		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">statement</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>in case of error all we can do is to just log the error</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">rowsAffected</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">execStatementAndGetRowsAffected</div><div class="operator">(</div><div class="ident">statement</div><div class="operator">,</div> <div class="ident">t</div><div class="operator">,</div> <div class="ident">clusterID</div><div class="operator">,</div> <div class="ident">triggerID</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">rowsAffected</div> <div class="operator">==</div> <div class="literal">0</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="operator">&amp;</div><div class="ident">ItemNotFoundError</div><div class="operator">{</div>
			<div class="ident">ItemID</div><div class="operator">:</div> <div class="ident">fmt</div><div class="operator">.</div><div class="ident">Sprintf</div><div class="operator">(</div><div class="literal">&#34;%v/%v&#34;</div><div class="operator">,</div> <div class="ident">clusterName</div><div class="operator">,</div> <div class="ident">triggerID</div><div class="operator">)</div><div class="operator">,</div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>QueryOne is generating Sql query using squirell sql builder, querying it with db store and mapping result to destination object with provided mapper</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">Storage</div><div class="operator">)</div> <div class="ident">QueryOne</div><div class="operator">(</div><div class="ident">ctx</div> <div class="ident">context</div><div class="operator">.</div><div class="ident">Context</div><div class="operator">,</div> <div class="ident">selectCols</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">Column</div><div class="operator">,</div> <div class="ident">selectBuilder</div> <div class="ident">sq</div><div class="operator">.</div><div class="ident">SelectBuilder</div><div class="operator">,</div> <div class="ident">mapper</div> <div class="keyword">func</div><div class="operator">(</div><div class="ident">Column</div><div class="operator">,</div> <div class="keyword">interface</div><div class="operator">{</div><div class="operator">}</div><div class="operator">)</div> <div class="operator">(</div><div class="keyword">interface</div><div class="operator">{</div><div class="operator">}</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div><div class="operator">,</div> <div class="ident">res</div> <div class="keyword">interface</div><div class="operator">{</div><div class="operator">}</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
	<div class="ident">q</div><div class="operator">,</div> <div class="ident">args</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">selectBuilder</div><div class="operator">.</div><div class="ident">ToSql</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="ident">rowScanner</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connections</div><div class="operator">.</div><div class="ident">QueryRowContext</div><div class="operator">(</div><div class="ident">ctx</div><div class="operator">,</div> <div class="ident">q</div><div class="operator">,</div> <div class="ident">args</div><div class="operator">...</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">rowScanner</div> <div class="operator">==</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">ErrUnknown</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">resMap</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">Map</div><div class="operator">(</div><div class="ident">selectCols</div><div class="operator">,</div> <div class="ident">mapper</div><div class="operator">,</div> <div class="ident">res</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">rowScanner</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div><div class="ident">resMap</div><div class="operator">...</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">==</div> <div class="ident">sql</div><div class="operator">.</div><div class="ident">ErrNoRows</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">ErrNoSuchObj</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Map creates a list of destination struct fields using columns to select</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">Storage</div><div class="operator">)</div> <div class="ident">Map</div><div class="operator">(</div><div class="ident">cols</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">Column</div><div class="operator">,</div> <div class="ident">mapper</div> <div class="keyword">func</div><div class="operator">(</div><div class="ident">Column</div><div class="operator">,</div> <div class="keyword">interface</div><div class="operator">{</div><div class="operator">}</div><div class="operator">)</div> <div class="operator">(</div><div class="keyword">interface</div><div class="operator">{</div><div class="operator">}</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div><div class="operator">,</div> <div class="ident">r</div> <div class="keyword">interface</div><div class="operator">{</div><div class="operator">}</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="keyword">interface</div><div class="operator">{</div><div class="operator">}</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">var</div> <div class="ident">mappedCols</div> <div class="operator">[</div><div class="operator">]</div><div class="keyword">interface</div><div class="operator">{</div><div class="operator">}</div><div class="operator"></div>
	<div class="keyword">for</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">c</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">cols</div> <div class="operator">{</div>
		<div class="ident">mc</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">mapper</div><div class="operator">(</div><div class="ident">c</div><div class="operator">,</div> <div class="ident">r</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
		<div class="ident">mappedCols</div> <div class="operator">=</div> <div class="ident">append</div><div class="operator">(</div><div class="ident">mappedCols</div><div class="operator">,</div> <div class="ident">mc</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">mappedCols</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Ping checks whether the database connection is really configured properly</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">Storage</div><div class="operator">)</div> <div class="ident">Ping</div><div class="operator">(</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
	<div class="ident">rows</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connections</div><div class="operator">.</div><div class="ident">Query</div><div class="operator">(</div><div class="literal">&#34;SELECT id, name FROM cluster LIMIT 1&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>ErrNoSuchObj is indicating no result returned from db</p>
</td>
	<td class="code"><pre><code><div class="keyword">var</div> <div class="ident">ErrNoSuchObj</div> <div class="operator">=</div> <div class="ident">fmt</div><div class="operator">.</div><div class="ident">Errorf</div><div class="operator">(</div><div class="literal">&#34;no such object&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>ErrUnknown indicates db query failed without details (QueryRow returning Row wasn't populated)</p>
</td>
	<td class="code"><pre><code><div class="keyword">var</div> <div class="ident">ErrUnknown</div> <div class="operator">=</div> <div class="ident">fmt</div><div class="operator">.</div><div class="ident">Errorf</div><div class="operator">(</div><div class="literal">&#34;unknown error during querying db&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
    </tbody>
  </table>
</div>
</body>
</html>
